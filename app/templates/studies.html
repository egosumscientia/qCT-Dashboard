{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <div>
    <h1>Study List</h1>
    <p class="subtitle">Filter and review simulated qCT studies across sites.</p>
  </div>
  <form class="filters" method="get">
    <label>
      Status
      <select name="status">
        <option value="" {% if not selected_status %}selected{% endif %}>All</option>
        <option value="ready" {% if selected_status == "ready" %}selected{% endif %}>Ready</option>
        <option value="processing" {% if selected_status == "processing" %}selected{% endif %}>Processing</option>
        <option value="review" {% if selected_status == "review" %}selected{% endif %}>Review</option>
      </select>
    </label>
    <label>
      Risk
      <select name="risk">
        <option value="" {% if not selected_risk %}selected{% endif %}>All</option>
        <option value="low" {% if selected_risk == "low" %}selected{% endif %}>Low</option>
        <option value="medium" {% if selected_risk == "medium" %}selected{% endif %}>Medium</option>
        <option value="high" {% if selected_risk == "high" %}selected{% endif %}>High</option>
      </select>
    </label>
    <label>
      Search
      <input
        type="search"
        name="q"
        value="{{ search_query }}"
        placeholder="Patient, anon ID, study ID"
      />
    </label>
    <label>
      Per page
      <select name="per_page">
        {% for size in [10, 20, 50] %}
        <option value="{{ size }}" {% if pagination.per_page == size %}selected{% endif %}>{{ size }}</option>
        {% endfor %}
      </select>
    </label>
    <input type="hidden" name="page" value="1" />
    <button type="submit">Apply</button>
  </form>
</section>

<section class="quick-filters" aria-label="Quick filters">
  <div class="quick-filters-group">
    <span class="quick-filters-label">Quick filters</span>
    <a class="quick-filter {% if selected_risk == 'high' %}active{% endif %}" href="/studies?risk=high&per_page={{ pagination.per_page }}">High risk</a>
    <a class="quick-filter {% if selected_status == 'ready' %}active{% endif %}" href="/studies?status=ready&per_page={{ pagination.per_page }}">Ready</a>
    <button type="button" class="quick-filter" data-quick-filter="last30">Last 30 days</button>
  </div>
  <div class="quick-filters-actions">
    <button type="button" class="quick-filter export" data-export="studies">Export CSV</button>
  </div>
</section>

<section class="panel">
  <div class="panel-meta">
    <div>
      <h2>Study Results</h2>
      <p class="subtitle">Estimated data quality for the current page.</p>
    </div>
    <div class="quality-summary" aria-live="polite">
      <div class="quality-item">
        <span>With image</span>
        <strong id="qualityImage">--</strong>
      </div>
      <div class="quality-item">
        <span>With summary</span>
        <strong id="qualitySummary">--</strong>
      </div>
    </div>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th>Study ID</th>
        <th>Patient (anon)</th>
        <th>Date</th>
        <th>Status</th>
        <th>Risk</th>
        <th>Nodule Count</th>
      </tr>
    </thead>
    <tbody>
      {% for study in studies %}
      {% set has_summary = study.status in ["ready", "review"] %}
      {% set has_image = study.status != "processing" %}
      <tr data-study-date="{{ study.study_date }}" data-status="{{ study.status }}" data-has-image="{{ 'true' if has_image else 'false' }}" data-has-summary="{{ 'true' if has_summary else 'false' }}">
        <td><a href="/studies/{{ study.id }}">{{ study.study_uid }}</a></td>
        <td>{{ study.patient_uid }}</td>
        <td>{{ study.study_date }}</td>
        <td><span class="pill {{ study.status }}">{{ study.status }}</span></td>
        <td><span class="pill risk-{{ study.overall_risk }}">{{ study.overall_risk }}</span></td>
        <td>{{ study.nodule_count }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <div class="empty-icon">(i)</div>
            <div>
              <strong>No studies match the current filters.</strong>
              <p class="muted">Try adjusting filters or clearing your search.</p>
            </div>
            {% if selected_status or selected_risk or search_query %}
            <a class="empty-action" href="/studies">Clear filters</a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="empty-state is-hidden" id="clientEmptyState">
    <div class="empty-icon">(i)</div>
    <div>
      <strong>No studies in the last 30 days on this page.</strong>
      <p class="muted">Try clearing the quick filter or change the page.</p>
    </div>
    <button type="button" class="empty-action" data-clear-quick-filter>Clear quick filter</button>
  </div>
  <div class="pagination">
    <div class="pagination-info">
      {% if pagination.total > 0 %}
      Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total] | min }}
      of {{ pagination.total }}
      {% else %}
      No results
      {% endif %}
    </div>
    <div class="pagination-controls">
      {% if pagination.page > 1 %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page - 1 }}">Previous</a>
      {% else %}
      <span class="pagination-link disabled">Previous</span>
      {% endif %}
      <span class="pagination-page">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
      <form class="pagination-jump" method="get">
        {% for key, value in request.query_params.items() %}
          {% if key != "page" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}" />
          {% endif %}
        {% endfor %}
        <label>
          Go to
          <input type="number" name="page" min="1" max="{{ pagination.total_pages }}" value="{{ pagination.page }}" />
        </label>
        <button type="submit">Go</button>
      </form>
      {% if pagination.page < pagination.total_pages %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page + 1 }}">Next</a>
      {% else %}
      <span class="pagination-link disabled">Next</span>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}

