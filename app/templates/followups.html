{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <div>
    <h1>Seguimiento longitudinal</h1>
    <p class="subtitle">Comparaciones informativas entre estudios.</p>
  </div>
</section>

<section class="panel">
  <div class="timeline-header">
    <div>
      <h2>Linea de tiempo de seguimiento</h2>
      <p class="subtitle">Comparaciones longitudinales mas recientes.</p>
    </div>
    <form class="pagination-form" method="get">
      <label>
        Buscar
        <input
          type="search"
          name="q"
          value="{{ search_query }}"
          placeholder="Paciente, nodulo, study ID"
        />
      </label>
      <label>
        Por pagina
        <select name="per_page">
          {% for size in [10, 20, 50] %}
          <option value="{{ size }}" {% if pagination.per_page == size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="page" value="1" />
      <button type="submit">Aplicar</button>
    </form>
  </div>
  {% if followups %}
  <div class="timeline">
    {% for item in followups %}
    {% set followup_label = "Estable" if item.status == "stable" else "En seguimiento" if item.status == "monitor" else item.status %}
    {% set risk_label = "Bajo" if item.risk == "low" else "Medio" if item.risk == "medium" else "Alto" if item.risk == "high" else item.risk %}
    <div class="timeline-item">
      <div class="timeline-date">
        <strong>{{ item.current_date }}</strong>
        <span class="muted">vs {{ item.prior_date }}</span>
      </div>
      <div class="timeline-card">
        <div class="timeline-card-header">
          <div class="timeline-title">
            <strong>{{ item.anon_label }}</strong>
          </div>
          <span class="pill risk-{{ item.risk }}">{{ risk_label }}</span>
        </div>
        <div class="timeline-meta">
          <div>
            <span>Nodulo</span>
            <strong>{{ item.nodule_uid }}</strong>
          </div>
          <div>
            <span>Crecimiento</span>
            <strong>{{ item.growth_percent }}%</strong>
          </div>
          <div>
            <span>Estado</span>
            <span class="pill {{ item.status }}">{{ followup_label }}</span>
          </div>
          <div>
            <span>Sitio</span>
            <strong>{{ item.site_name }}</strong>
          </div>
        </div>
        <div class="timeline-links">
          <a href="/studies/{{ item.current_study_id }}">Ver estudio actual</a>
          <span class="muted">Previo: {{ item.prior_study_uid }}</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="pagination">
    <div class="pagination-info">
      {% if pagination.total > 0 %}
      Mostrando {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total] | min }}
      de {{ pagination.total }}
      {% else %}
      Sin resultados
      {% endif %}
    </div>
    <div class="pagination-controls">
      {% if pagination.page > 1 %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page - 1 }}">Anterior</a>
      {% else %}
      <span class="pagination-link disabled">Anterior</span>
      {% endif %}
      <span class="pagination-page">Pagina {{ pagination.page }} de {{ pagination.total_pages }}</span>
      <form class="pagination-jump" method="get">
        {% for key, value in request.query_params.items() %}
          {% if key != "page" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}" />
          {% endif %}
        {% endfor %}
        <label>
          Ir a
          <input type="number" name="page" min="1" max="{{ pagination.total_pages }}" value="{{ pagination.page }}" />
        </label>
        <button type="submit">Ir</button>
      </form>
      {% if pagination.page < pagination.total_pages %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page + 1 }}">Siguiente</a>
      {% else %}
      <span class="pagination-link disabled">Siguiente</span>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">(i)</div>
    <div>
      <strong>No hay comparaciones disponibles.</strong>
      <p class="muted">Prueba ajustar la busqueda o limpiarla para ver resultados.</p>
    </div>
    {% if search_query %}
    <a class="empty-action" href="/followups">Limpiar busqueda</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}



