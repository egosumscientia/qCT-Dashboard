{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <div>
    <h1>Eventos de ingesta</h1>
    <p class="subtitle">Vista informativa de eventos de ingesta y procesamiento.</p>
  </div>
</section>

<section class="panel">
  <div class="timeline-header">
    <div>
      <h2>Pipeline de procesamiento</h2>
      <p class="subtitle">Eventos mas recientes por estudio.</p>
    </div>
    <form class="pagination-form" method="get">
      <label>
        Buscar
        <input
          type="search"
          name="q"
          value="{{ search_query }}"
          placeholder="Paciente, study ID, mensaje"
        />
      </label>
      <label>
        Por pagina
        <select name="per_page">
          {% for size in [10, 20, 50] %}
          <option value="{{ size }}" {% if pagination.per_page == size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="page" value="1" />
      <button type="submit">Aplicar</button>
    </form>
  </div>
  {% if logs %}
  <div class="timeline">
    {% for log in logs %}
    {% set log_label = "Completado" if log.status == "completed" else "En proceso" if log.status == "processing" else log.status %}
    <div class="timeline-item">
      <div class="timeline-date">
        <strong>{{ log.started_at }}</strong>
        <span class="muted">{% if log.completed_at %}Finalizado {{ log.completed_at }}{% else %}En proceso{% endif %}</span>
      </div>
      <div class="timeline-card">
        <div class="timeline-card-header">
          <div class="timeline-title">
            <strong>{{ log.anon_label }}</strong>
          </div>
          <span class="pill {{ log.status }}">{{ log_label }}</span>
        </div>
        <div class="timeline-meta">
          <div>
            <span>Estudio</span>
            <strong>{{ log.study_uid }}</strong>
          </div>
          <div>
            <span>Sitio</span>
            <strong>{{ log.site_name }}</strong>
          </div>
          <div>
            <span>Mensaje</span>
            <strong>{{ log.message }}</strong>
          </div>
        </div>
        <div class="timeline-links">
          <a href="/studies/{{ log.study_id }}">Ver estudio</a>
          <span class="muted">Estado: {{ log_label }}</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="pagination">
    <div class="pagination-info">
      {% if pagination.total > 0 %}
      Mostrando {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total] | min }}
      de {{ pagination.total }}
      {% else %}
      Sin resultados
      {% endif %}
    </div>
    <div class="pagination-controls">
      {% if pagination.page > 1 %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page - 1 }}">Anterior</a>
      {% else %}
      <span class="pagination-link disabled">Anterior</span>
      {% endif %}
      <span class="pagination-page">Pagina {{ pagination.page }} de {{ pagination.total_pages }}</span>
      <form class="pagination-jump" method="get">
        {% for key, value in request.query_params.items() %}
          {% if key != "page" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}" />
          {% endif %}
        {% endfor %}
        <label>
          Ir a
          <input type="number" name="page" min="1" max="{{ pagination.total_pages }}" value="{{ pagination.page }}" />
        </label>
        <button type="submit">Ir</button>
      </form>
      {% if pagination.page < pagination.total_pages %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page + 1 }}">Siguiente</a>
      {% else %}
      <span class="pagination-link disabled">Siguiente</span>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">(i)</div>
    <div>
      <strong>No hay eventos de ingesta disponibles.</strong>
      <p class="muted">Prueba ajustar la busqueda o limpiarla para ver resultados.</p>
    </div>
    {% if search_query %}
    <a class="empty-action" href="/ingestion">Limpiar busqueda</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}



