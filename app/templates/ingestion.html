{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <div>
    <h1>Ingestion Logs</h1>
    <p class="subtitle">Scaffolded monitoring view for ingestion and processing events.</p>
  </div>
</section>

<section class="panel">
  <div class="timeline-header">
    <div>
      <h2>Processing Pipeline</h2>
      <p class="subtitle">Latest ingestion and processing events across studies.</p>
    </div>
    <form class="pagination-form" method="get">
      <label>
        Search
        <input
          type="search"
          name="q"
          value="{{ search_query }}"
          placeholder="Patient, study ID, message"
        />
      </label>
      <label>
        Per page
        <select name="per_page">
          {% for size in [10, 20, 50] %}
          <option value="{{ size }}" {% if pagination.per_page == size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="page" value="1" />
      <button type="submit">Apply</button>
    </form>
  </div>
  {% if logs %}
  <div class="timeline">
    {% for log in logs %}
    <div class="timeline-item">
      <div class="timeline-date">
        <strong>{{ log.started_at }}</strong>
        <span class="muted">{% if log.completed_at %}Done {{ log.completed_at }}{% else %}In progress{% endif %}</span>
      </div>
      <div class="timeline-card">
        <div class="timeline-card-header">
          <div class="timeline-title">
            <strong>{{ log.anon_label }}</strong>
          </div>
          <span class="pill {{ log.status }}">{{ log.status }}</span>
        </div>
        <div class="timeline-meta">
          <div>
            <span>Study</span>
            <strong>{{ log.study_uid }}</strong>
          </div>
          <div>
            <span>Site</span>
            <strong>{{ log.site_name }}</strong>
          </div>
          <div>
            <span>Message</span>
            <strong>{{ log.message }}</strong>
          </div>
        </div>
        <div class="timeline-links">
          <a href="/studies/{{ log.study_id }}">View study</a>
          <span class="muted">Status: {{ log.status }}</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="pagination">
    <div class="pagination-info">
      {% if pagination.total > 0 %}
      Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total] | min }}
      of {{ pagination.total }}
      {% else %}
      No results
      {% endif %}
    </div>
    <div class="pagination-controls">
      {% if pagination.page > 1 %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page - 1 }}">Previous</a>
      {% else %}
      <span class="pagination-link disabled">Previous</span>
      {% endif %}
      <span class="pagination-page">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
      <form class="pagination-jump" method="get">
        {% for key, value in request.query_params.items() %}
          {% if key != "page" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}" />
          {% endif %}
        {% endfor %}
        <label>
          Go to
          <input type="number" name="page" min="1" max="{{ pagination.total_pages }}" value="{{ pagination.page }}" />
        </label>
        <button type="submit">Go</button>
      </form>
      {% if pagination.page < pagination.total_pages %}
      <a class="pagination-link" href="?{{ pagination.base_query }}&page={{ pagination.page + 1 }}">Next</a>
      {% else %}
      <span class="pagination-link disabled">Next</span>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">(i)</div>
    <div>
      <strong>No ingestion logs available.</strong>
      <p class="muted">Try adjusting the search query or clear it to see all results.</p>
    </div>
    {% if search_query %}
    <a class="empty-action" href="/ingestion">Clear search</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}



